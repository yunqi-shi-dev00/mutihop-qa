# 质量检查系统说明

## 概述

本系统实现了严格的**4层质量检查机制**，确保生成的QA都是高质量的。只有通过所有检查的QA才会被计入成功数量。

## 质量检查流程（4个检查）

### 检查1：有效性检查 (qa_valid_check)

**目的**：确保问答对逻辑合理

**检查标准**：
1. 问题不是简单拼接多个问题
2. 提供的答案是唯一正确答案
3. 问题有唯一答案
4. 基于相关技术陈述可以解答
5. 问题答案语法合理，可读性强
6. 问题没有事实错误
7. 答案中没有事实错误
8. 答案围绕子问答对回答的，没有过于发散
9. 答案没有引入子问答对中没有的信息
10. 问题涉及的所有技术点都在子问答对中有明确提及

**未通过**：`continue`（跳过这一轮，不计数）

---

### 检查2：直接生成测试 (direct_generate)

**目的**：测试LLM能否回答这个问题

**流程**：
1. 使用LLM生成4个答案（n=4）
2. 检查是否能成功生成

**示例**：
```
问题: "在InGaZnO₄靶材制备中，烧结温度需达到多少？"
生成4个答案:
1. "500℃"
2. "600℃"
3. "通常300-400℃"
4. None
```

**未通过**：生成失败 → `continue`

---

### 检查3：LLM判断答案 (llm_judge_answer)

**目的**：判断生成的答案是否正确

**流程**：
1. 对4个生成的答案，逐一判断是否与标准答案一致
2. 返回布尔列表，如`[False, False, False, False]`

**注意**：
- ✅ **允许4个全错**（说明问题够难，LLM答不出来）
- ✅ 允许部分正确（如`[True, False, False, False]`）
- 只要能生成并判断，就通过这一关

---

### 检查4：替代答案检查 (check_alternative_answer)

**目的**：确保答案唯一性（没有其他正确答案）

**流程**：
1. 对于被判为"错误"的答案，检查是否也是正确答案
2. 如果某个"错误答案"也满足问题的所有约束 → 有歧义

**示例**：

❌ **有歧义的情况**：
```
问题: "IGZO薄膜退火温度是多少？"
标准答案: "350℃"
生成答案1: "300-400℃"（被判错）

检查: "300-400℃"包含了350℃，也是正确答案
结果: is_alternative=True → continue（拒绝）
```

✅ **无歧义的情况**：
```
问题: "在InGaZnO₄靶材制备中，烧结温度需达到多少？"
标准答案: "1200℃以上"
生成答案1: "500℃"（被判错）

检查: "500℃"与"1200℃以上"矛盾，不是正确答案
结果: is_alternative=False → 通过
```

**未通过**：存在替代答案 → `continue`

---

## ✅ 通过所有检查

只有通过以上4个检查，QA才会：
1. `memory = memory_new`（接受这一轮修改）
2. 保存为1个成功的QA
3. 设置`passed_all_checks: true`

---

## 质量标志字段

每个生成的QA文件包含以下质量标志：

```json
{
  "uid": "...",
  "question": "...",
  "answer": "...",
  
  // ⭐ 质量标志
  "passed_all_checks": true,        // 通过了所有4个检查
  "passed_filtering": true,          // 通过了6大评估标准
  "answer_regenerated": true,        // 经过了答案重生成
  "direct_gen_acc": "2/4",          // 直接生成准确率
  
  // 功能开关
  "qa_filtering_enabled": true,
  "answer_regeneration_enabled": true,
  "bridge_check_enabled": true,
  "dynamic_planning_enabled": true
}
```

---

## Quality Filter High

**筛选标准**（必须全部满足）：

```python
passed_all_checks = True         # 通过了所有4个检查
passed_filtering = True          # 通过了6大评估标准
answer_regenerated = True        # 经过了答案重生成
```

**使用方式**：

生成完成后，系统会自动调用`filter_by_quality()`函数，筛选出高质量QA，并生成：
- `high_quality_qa_list.json`：高质量QA列表和统计

---

## 统计信息

生成完成后会显示：

```
总生成数: 120          # 总共尝试生成的QA数量
高质量QA数: 50         # 通过所有检查的QA数量
质量通过率: 41.7%      # 高质量QA占比
```

---

## 关键区别：注释版 vs 当前版

| 特性 | 注释版（旧） | 当前版（新） |
|-----|------------|------------|
| 有效性检查 | ✓ | ✓ |
| 直接生成测试 | ✓ | ✓ **（已恢复）** |
| LLM判断答案 | ✓ | ✓ **（已恢复）** |
| 替代答案检查 | ✓ | ✓ **（已恢复）** |
| 6大评估标准 | ✗ | ✓ |
| 答案重生成 | ✗ | ✓ |
| 桥联合理性检查 | ✗ | ✓ |
| Quality Filter | ✓ | ✓ **（已实现）** |

---

## 使用示例

```bash
python main_final.py \
    --input /path/to/QA.jsonl \
    --output ./generated_qa \
    --model_path /path/to/model \
    --batch_size 4 \
    --target_count 50 \
    --debug
```

**说明**：
- `--target_count 50`：目标生成50个**高质量QA**（通过所有检查）
- 实际会生成更多（如120个），但只有50个通过所有检查
- 最终输出50个高质量QA文件 + `high_quality_qa_list.json`

---

## 常见问题

### Q1: 为什么允许4个答案都错？

**A**：说明问题难度够高，LLM答不出来，这正是我们想要的。关键是确保答案唯一性（没有歧义），而不是要求LLM能答对。

### Q2: 质量通过率一般是多少？

**A**：根据经验，通常在30%-50%之间。如果过低（<20%），可能需要调整prompt或检查参数。

### Q3: 如何提高质量通过率？

**A**：
1. 使用更好的基础QA数据
2. 调整prompt模板
3. 使用更强大的LLM模型
4. 适当放宽某些检查标准（不推荐）

---

## 技术细节

### 检查流程代码位置

- **agent_final_new.py**：第1068-1134行
- **utils.py**：第268-339行（filter_by_quality函数）
- **main_final.py**：第251-268行（自动调用质量筛选）

### 相关Prompt模板

- `qa_valid_check`：有效性检查
- `direct_gen_check`：直接生成测试
- `llm_judge`：LLM判断答案
- `check_alternative_ans`：替代答案检查
- `question_evaluation`：6大评估标准

---

## 更新日志

**2025-11-24**：
- ✅ 恢复4个质量检查流程
- ✅ 实现Quality Filter High功能
- ✅ 确保只有通过所有检查的才保存
- ✅ 添加质量标志字段
- ✅ 自动生成高质量QA列表
